# Subliminal Master ç³»ç»Ÿå…¨é¢å®¡æŸ¥æŠ¥å‘Š v2

> å®¡æŸ¥æ—¥æœŸï¼š2026-02-21
> ç‰ˆæœ¬ï¼šv3.4.0
> å®¡æŸ¥èŒƒå›´ï¼šå®‰å…¨ã€æ€§èƒ½ã€åŠŸèƒ½ã€ä»£ç è´¨é‡ã€éƒ¨ç½²

---

## ä¸€ã€å®‰å…¨é—®é¢˜ ğŸ”´ é«˜ä¼˜å…ˆçº§

### 1.1 CSRF ä¿æŠ¤ç¼ºå¤±
**é£é™©çº§åˆ«**: é«˜
**æ–‡ä»¶**: `subliminal_master.py`

**é—®é¢˜æè¿°**:
Flask åº”ç”¨æ²¡æœ‰å¯ç”¨ CSRF ä¿æŠ¤ï¼Œå¯èƒ½é­å—è·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»ã€‚

**å½“å‰ä»£ç **:
```python
app = Flask(__name__)
app.config['MAX_CONTENT_LENGTH'] = Config.MAX_CONTENT_LENGTH
# ç¼ºå°‘ SECRET_KEY å’Œ CSRF ä¿æŠ¤
```

**å»ºè®®ä¿®å¤**:
```python
app = Flask(__name__)
app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', os.urandom(24))
app.config['MAX_CONTENT_LENGTH'] = Config.MAX_CONTENT_LENGTH
# ä½¿ç”¨ Flask-WTF æˆ–æ‰‹åŠ¨éªŒè¯ CSRF token
```

---

### 1.2 è¯·æ±‚é¢‘ç‡é™åˆ¶ç¼ºå¤±
**é£é™©çº§åˆ«**: é«˜
**æ–‡ä»¶**: `subliminal_master.py`

**é—®é¢˜æè¿°**:
æ²¡æœ‰è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œå¯èƒ½è¢« DDoS æ”»å‡»æˆ–èµ„æºè€—å°½ã€‚

**å»ºè®®ä¿®å¤**:
```python
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

limiter = Limiter(
    app=app,
    key_func=get_remote_address,
    default_limits=["200 per day", "50 per hour"]
)

@app.route('/process', methods=['POST'])
@limiter.limit("10 per hour")  # å¤„ç†æ¥å£æ›´ä¸¥æ ¼
def process():
    ...
```

---

### 1.3 ä¸Šä¼ æ–‡ä»¶æœªåŠæ—¶æ¸…ç†
**é£é™©çº§åˆ«**: ä¸­
**æ–‡ä»¶**: `subliminal_master.py` ç¬¬189-190è¡Œ

**é—®é¢˜æè¿°**:
ä¸Šä¼ çš„æ–‡ä»¶ä¿å­˜åï¼Œå³ä½¿å¤„ç†å¤±è´¥ä¹Ÿä¸ä¼šç«‹å³åˆ é™¤ï¼Œä¾èµ–å®šæ—¶æ¸…ç†ã€‚

**å½“å‰ä»£ç **:
```python
affirmation_file.save(affirmation_path)
background_file.save(background_path)
# å¤„ç†å¤±è´¥æ—¶æ–‡ä»¶ä»ç„¶å­˜åœ¨
```

**å»ºè®®ä¿®å¤**:
```python
try:
    affirmation_file.save(affirmation_path)
    background_file.save(background_path)
    # ... å¤„ç†é€»è¾‘
finally:
    # å¤„ç†å®Œæˆåç«‹å³æ¸…ç†ä¸Šä¼ æ–‡ä»¶
    for path in [affirmation_path, background_path]:
        if os.path.exists(path):
            os.remove(path)
```

---

### 1.4 å‚æ•°æœªéªŒè¯
**é£é™©çº§åˆ«**: ä¸­
**æ–‡ä»¶**: `subliminal_master.py` ç¬¬178-181è¡Œ

**é—®é¢˜æè¿°**:
å‰ç«¯ä¼ å…¥çš„é…ç½®å‚æ•°æ²¡æœ‰åç«¯éªŒè¯ï¼Œå¯èƒ½å¯¼è‡´å¼‚å¸¸æˆ–å®‰å…¨é—®é¢˜ã€‚

**å½“å‰ä»£ç **:
```python
config = json.loads(request.form.get('config', '{}'))
# ç›´æ¥ä½¿ç”¨ï¼Œæ²¡æœ‰éªŒè¯
```

**å»ºè®®ä¿®å¤**:
```python
def validate_config(config):
    """éªŒè¯é…ç½®å‚æ•°"""
    errors = []
    
    carrier_freq = config.get('carrier_freq', 17500)
    if not (15000 <= carrier_freq <= 20000):
        errors.append('è½½æ³¢é¢‘ç‡è¶…å‡ºèŒƒå›´')
    
    # ... å…¶ä»–éªŒè¯
    
    return len(errors) == 0, errors

config = json.loads(request.form.get('config', '{}'))
valid, errors = validate_config(config)
if not valid:
    return jsonify({'success': False, 'error': '; '.join(errors)})
```

---

## äºŒã€æ€§èƒ½é—®é¢˜ ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

### 2.1 å¹¶å‘å¤„ç†ç¼ºå¤±
**å½±å“**: é«˜
**æ–‡ä»¶**: `subliminal_master.py`

**é—®é¢˜æè¿°**:
å¤šä¸ªå¤§æ–‡ä»¶åŒæ—¶å¤„ç†å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºæˆ–æœåŠ¡å™¨å´©æºƒã€‚

**å»ºè®®ä¿®å¤**:
```python
import threading

# é™åˆ¶å¹¶å‘å¤„ç†æ•°é‡
MAX_CONCURRENT_PROCESSES = 2
process_semaphore = threading.Semaphore(MAX_CONCURRENT_PROCESSES)

@app.route('/process', methods=['POST'])
def process():
    if not process_semaphore.acquire(blocking=False):
        return jsonify({
            'success': False, 
            'error': 'æœåŠ¡å™¨ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•'
        })
    try:
        # å¤„ç†é€»è¾‘
        ...
    finally:
        process_semaphore.release()
```

---

### 2.2 å¤§æ–‡ä»¶å†…å­˜é—®é¢˜
**å½±å“**: é«˜
**æ–‡ä»¶**: `audio_processor.py`

**é—®é¢˜æè¿°**:
å¤§éŸ³é¢‘æ–‡ä»¶å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜ä¸è¶³ã€‚

**å½“å‰ä»£ç **:
```python
affirmation_audio = AudioSegment.from_file(affirmation_path)
# æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜
```

**å»ºè®®ä¿®å¤**:
- æ·»åŠ éŸ³é¢‘æ—¶é•¿é™åˆ¶ï¼ˆå¦‚æœ€å¤§30åˆ†é’Ÿï¼‰
- æˆ–ä½¿ç”¨æµå¼å¤„ç†ï¼ˆå¤æ‚åº¦è¾ƒé«˜ï¼‰

```python
# ç®€å•æ–¹æ¡ˆï¼šé™åˆ¶æ—¶é•¿
MAX_AUDIO_DURATION = 30 * 60 * 1000  # 30åˆ†é’Ÿ

audio = AudioSegment.from_file(file_path)
if len(audio) > MAX_AUDIO_DURATION:
    return False, "éŸ³é¢‘æ—¶é•¿è¶…è¿‡30åˆ†é’Ÿé™åˆ¶"
```

---

### 2.3 å†å²è®°å½•æ— ç¼“å­˜
**å½±å“**: ä½
**æ–‡ä»¶**: `subliminal_master.py` ç¬¬274-309è¡Œ

**é—®é¢˜æè¿°**:
æ¯æ¬¡è¯·æ±‚å†å²è®°å½•éƒ½è¦éå†æ–‡ä»¶ç³»ç»Ÿï¼Œæ•ˆç‡ä½ã€‚

**å»ºè®®ä¿®å¤**:
```python
from functools import lru_cache
import time

@lru_cache(maxsize=1)
def get_history_cached(cache_key):
    """å¸¦ç¼“å­˜çš„å†å²è®°å½•"""
    # ... åŸæœ‰é€»è¾‘

@app.route('/api/history')
def get_history():
    # æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ç¼“å­˜
    cache_key = int(time.time() / 60)
    return get_history_cached(cache_key)
```

---

## ä¸‰ã€åŠŸèƒ½ç¼ºé™· ğŸŸ  ä¸­ä¼˜å…ˆçº§

### 3.1 å–æ¶ˆåŠŸèƒ½ä¸å®Œæ•´
**å½±å“**: ä¸­
**æ–‡ä»¶**: `templates/index.html`

**é—®é¢˜æè¿°**:
å‰ç«¯å–æ¶ˆåªæ˜¯ä¸­æ–­ HTTP è¯·æ±‚ï¼Œåç«¯ä»åœ¨ç»§ç»­å¤„ç†éŸ³é¢‘ã€‚

**å»ºè®®ä¿®å¤**:
ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå¦‚ Celeryï¼‰æˆ–åå°çº¿ç¨‹ï¼Œæ”¯æŒçœŸæ­£çš„å–æ¶ˆï¼š

```python
import threading
import uuid

processing_tasks = {}

def process_audio_task(task_id, affirmation_path, background_path, config):
    """åå°å¤„ç†ä»»åŠ¡"""
    task = processing_tasks[task_id]
    task['status'] = 'processing'
    # ... å¤„ç†é€»è¾‘
    task['status'] = 'completed'

@app.route('/process', methods=['POST'])
def process():
    task_id = str(uuid.uuid4())
    processing_tasks[task_id] = {
        'status': 'pending',
        'cancelled': False
    }
    # å¯åŠ¨åå°ä»»åŠ¡
    thread = threading.Thread(
        target=process_audio_task,
        args=(task_id, affirmation_path, background_path, config)
    )
    thread.start()
    return jsonify({'task_id': task_id})

@app.route('/cancel/<task_id>', methods=['POST'])
def cancel_task(task_id):
    if task_id in processing_tasks:
        processing_tasks[task_id]['cancelled'] = True
        return jsonify({'success': True})
    return jsonify({'success': False}), 404
```

---

### 3.2 æ–‡ä»¶å»é‡ç¼ºå¤±
**å½±å“**: ä½
**æ–‡ä»¶**: `subliminal_master.py`

**é—®é¢˜æè¿°**:
ç›¸åŒæ–‡ä»¶é‡å¤ä¸Šä¼ ä¼šé‡å¤å¤„ç†ï¼Œæµªè´¹èµ„æºã€‚

**å»ºè®®ä¿®å¤**:
```python
import hashlib

def get_file_hash(file_path):
    """è®¡ç®—æ–‡ä»¶MD5å“ˆå¸Œ"""
    hash_md5 = hashlib.md5()
    with open(file_path, "rb") as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hash_md5.update(chunk)
    return hash_md5.hexdigest()

# æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡
file_hash = get_file_hash(affirmation_path)
cache_key = f"{file_hash}_{config_hash}"
if cache_key in processed_cache:
    # è¿”å›ç¼“å­˜ç»“æœ
    return jsonify(processed_cache[cache_key])
```

---

### 3.3 ç”¨æˆ·åé¦ˆä¸è¶³
**å½±å“**: ä½
**æ–‡ä»¶**: `templates/index.html`

**é—®é¢˜æè¿°**:
å¤„ç†å¤±è´¥æ—¶ç”¨æˆ·æ— æ³•çŸ¥é“å…·ä½“åŸå› ã€‚

**å»ºè®®ä¿®å¤**:
æ·»åŠ è¯¦ç»†çš„é”™è¯¯ç±»å‹å’Œè§£å†³å»ºè®®ï¼š
```javascript
const ERROR_SOLUTIONS = {
    'invalid_audio': {
        title: 'éŸ³é¢‘æ–‡ä»¶æ— æ•ˆ',
        solution: 'è¯·å°è¯•ç”¨å…¶ä»–æ’­æ”¾å™¨æ‰“å¼€æ–‡ä»¶ï¼Œç¡®è®¤æ–‡ä»¶æœªæŸå'
    },
    'file_too_large': {
        title: 'æ–‡ä»¶è¿‡å¤§',
        solution: 'è¯·å‹ç¼©éŸ³é¢‘æˆ–ä½¿ç”¨è¾ƒçŸ­çš„éŸ³ä¹æ–‡ä»¶'
    },
    // ...
};
```

---

## å››ã€ä»£ç è´¨é‡é—®é¢˜ ğŸŸ¢ ä½ä¼˜å…ˆçº§

### 4.1 ç¼ºå°‘ç±»å‹æ³¨è§£
**æ–‡ä»¶**: æ‰€æœ‰ Python æ–‡ä»¶

**é—®é¢˜æè¿°**:
å‡½æ•°å‚æ•°å’Œè¿”å›å€¼æ²¡æœ‰ç±»å‹æ³¨è§£ï¼Œé™ä½ä»£ç å¯è¯»æ€§ã€‚

**å»ºè®®ä¿®å¤**:
```python
from typing import Dict, Tuple, Optional, Any

def validate_config(config: Dict[str, Any]) -> Tuple[bool, list]:
    """éªŒè¯é…ç½®å‚æ•°"""
    ...

def mix_subliminal_audio(
    affirmation_path: str, 
    background_path: str, 
    config: Dict[str, Any], 
    progress_callback: Optional[callable] = None
) -> Tuple[bool, Dict[str, Any] | str]:
    """æ··åˆæ½œæ„è¯†éŸ³é¢‘"""
    ...
```

---

### 4.2 ç¼ºå°‘ Flask è“å›¾
**æ–‡ä»¶**: `subliminal_master.py`

**é—®é¢˜æè¿°**:
æ‰€æœ‰è·¯ç”±éƒ½åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œä¸åˆ©äºç»´æŠ¤å’Œæ‰©å±•ã€‚

**å»ºè®®ä¿®å¤**:
```
é¡¹ç›®ç»“æ„:
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ main.py
â”‚   â”‚   â”œâ”€â”€ api.py
â”‚   â”‚   â””â”€â”€ download.py
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ audio_processor.py
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ file_cleaner.py
```

---

### 4.3 é…ç½®éªŒè¯ç¼ºå¤±
**æ–‡ä»¶**: `config.py`

**é—®é¢˜æè¿°**:
ç¯å¢ƒå˜é‡æ²¡æœ‰éªŒè¯ï¼Œå¯èƒ½è®¾ç½®æ— æ•ˆå€¼ã€‚

**å»ºè®®ä¿®å¤**:
```python
class Config:
    @classmethod
    def validate(cls):
        """éªŒè¯é…ç½®"""
        errors = []
        
        if cls.PORT < 1 or cls.PORT > 65535:
            errors.append(f'æ— æ•ˆç«¯å£: {cls.PORT}')
        
        if cls.FILE_CLEANUP_HOURS < 1:
            errors.append(f'æ¸…ç†æ—¶é—´è¿‡çŸ­: {cls.FILE_CLEANUP_HOURS}')
        
        if errors:
            raise ValueError('\n'.join(errors))
```

---

## äº”ã€éƒ¨ç½²é—®é¢˜ ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

### 5.1 å¥åº·æ£€æŸ¥ä¸å®Œæ•´
**æ–‡ä»¶**: `subliminal_master.py` ç¬¬262-265è¡Œ

**é—®é¢˜æè¿°**:
å¥åº·æ£€æŸ¥åªè¿”å›çŠ¶æ€ï¼Œä¸æ£€æŸ¥ä¾èµ–æœåŠ¡ã€‚

**å»ºè®®ä¿®å¤**:
```python
@app.route('/health')
def health():
    """å¥åº·æ£€æŸ¥æ¥å£"""
    status = {
        'status': 'ok',
        'version': Config.APP_VERSION,
        'checks': {}
    }
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    import shutil
    disk = shutil.disk_usage('/')
    status['checks']['disk'] = {
        'free_gb': disk.free / (1024**3),
        'percent': disk.free / disk.total * 100
    }
    
    # æ£€æŸ¥æ–‡ä»¶å¤¹æƒé™
    for folder in [Config.UPLOAD_FOLDER, Config.OUTPUT_FOLDER]:
        status['checks'][folder] = os.access(folder, os.W_OK)
    
    return jsonify(status)
```

---

### 5.2 ä¼˜é›…å…³é—­ç¼ºå¤±
**æ–‡ä»¶**: `subliminal_master.py`

**é—®é¢˜æè¿°**:
æœåŠ¡å…³é—­æ—¶æ²¡æœ‰ç­‰å¾…æ­£åœ¨å¤„ç†çš„è¯·æ±‚å®Œæˆã€‚

**å»ºè®®ä¿®å¤**:
```python
import signal
import atexit

def graceful_shutdown(signum, frame):
    """ä¼˜é›…å…³é—­"""
    logger.info("æ­£åœ¨å…³é—­æœåŠ¡...")
    file_cleaner.stop()
    # ç­‰å¾…æ­£åœ¨å¤„ç†çš„è¯·æ±‚
    # ...
    sys.exit(0)

signal.signal(signal.SIGTERM, graceful_shutdown)
signal.signal(signal.SIGINT, graceful_shutdown)
atexit.register(file_cleaner.stop)
```

---

### 5.3 æ—¥å¿—çº§åˆ«é…ç½®
**æ–‡ä»¶**: `config.py`

**é—®é¢˜æè¿°**:
ç”Ÿäº§ç¯å¢ƒæ—¥å¿—çº§åˆ«å¯èƒ½ä¸åˆé€‚ã€‚

**å»ºè®®ä¿®å¤**:
```python
# æ ¹æ®ç¯å¢ƒè‡ªåŠ¨è°ƒæ•´
import os

DEBUG = os.environ.get('FLASK_DEBUG', 'False').lower() == 'true'
LOG_LEVEL = os.environ.get('LOG_LEVEL', 'WARNING' if not DEBUG else 'DEBUG')
```

---

## å…­ã€ä¿®å¤ä¼˜å…ˆçº§æ’åº

### ç¬¬ä¸€æ‰¹ï¼ˆç«‹å³ä¿®å¤ï¼‰ğŸ”´
1. CSRF ä¿æŠ¤ç¼ºå¤±
2. è¯·æ±‚é¢‘ç‡é™åˆ¶
3. å‚æ•°éªŒè¯
4. å¹¶å‘å¤„ç†é™åˆ¶

### ç¬¬äºŒæ‰¹ï¼ˆè¿‘æœŸä¿®å¤ï¼‰ğŸŸ¡
5. ä¸Šä¼ æ–‡ä»¶åŠæ—¶æ¸…ç†
6. å¤§æ–‡ä»¶æ—¶é•¿é™åˆ¶
7. å–æ¶ˆåŠŸèƒ½å®Œå–„
8. å¥åº·æ£€æŸ¥å®Œå–„

### ç¬¬ä¸‰æ‰¹ï¼ˆåç»­ä¼˜åŒ–ï¼‰ğŸŸ¢
9. å†å²è®°å½•ç¼“å­˜
10. æ–‡ä»¶å»é‡
11. ç±»å‹æ³¨è§£
12. Flask è“å›¾é‡æ„

---

## ä¸ƒã€ä¿®å¤ç»Ÿè®¡

| ç±»åˆ« | é—®é¢˜æ•° | é«˜ä¼˜å…ˆçº§ | ä¸­ä¼˜å…ˆçº§ | ä½ä¼˜å…ˆçº§ |
|------|--------|----------|----------|----------|
| å®‰å…¨é—®é¢˜ | 4 | 2 | 2 | 0 |
| æ€§èƒ½é—®é¢˜ | 3 | 1 | 1 | 1 |
| åŠŸèƒ½ç¼ºé™· | 3 | 0 | 2 | 1 |
| ä»£ç è´¨é‡ | 3 | 0 | 0 | 3 |
| éƒ¨ç½²é—®é¢˜ | 3 | 0 | 2 | 1 |
| **æ€»è®¡** | **16** | **3** | **7** | **6** |

---

*æœ¬æŠ¥å‘ŠåŸºäº v3.4.0 ç‰ˆæœ¬å®¡æŸ¥ï¼Œå»ºè®®æŒ‰ä¼˜å…ˆçº§é€æ­¥ä¿®å¤ã€‚*
